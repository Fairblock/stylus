// Copyright 2023, Offchain Labs, Inc.
// For license information, see https://github.com/nitro/blob/master/LICENSE
use ethers::types::{H160, U256};

use crate::{constants, deploy};

/// Defines the different types of calls that can be made in a multicall transaction.
#[derive(Clone)]
#[allow(dead_code)]
enum MulticallArg {
    Call,
    DelegateCall,
    StaticCall,
}

/// Convertes a multicall into an opcode (byte).
impl From<MulticallArg> for u8 {
    fn from(value: MulticallArg) -> Self {
        match value {
            MulticallArg::Call => 0x00,
            MulticallArg::DelegateCall => 0x01,
            MulticallArg::StaticCall => 0x02,
        }
    }
}

/// Prepares the data for a deploy and compile multicall tx.
pub fn prepare_deploy_compile_multicall(
    compressed_wasm: &[u8],
    expected_address: &H160,
) -> Vec<u8> {
    let compressed = hex::decode("ef0000001b1f5c25d36d7228b78348527047cf06d3e03c406151f78011a9357322aaea65819321826e4f5bbcdbe7e152abd7ed20c672cad05f6cb463c53627ab66391e2b340ea1b0b0b86a21ca67a375380a6acd0235df0fb8af8f82a615d4baaa6c95ca0ac5be8a6375fdf8190b2fcc1367803b395247a2ff6fceb77b25d991e135fa804e1b15719097b3054c06807362950701321d605c2278d0cedabec080876d81e40ec4f3d512eab7f896244ddb99dd7f8ae7e1044620dc290bfcffff3bcbde93545d4a5fa9ad611764663f0d395033eceab04e2d742ab5aaff06a8bf02cf21757b39613be000d630c0271042116b3a8965216fd7955d48f55a562aa4fe0b4b7a74e702482acc2fcc7b21c5499eecd84ed33ee02a824fc8081f60636c68e1fd529223c00d8cd331d40ed1e7f4f7aa96ed7f0f80c0bb2ce874778ea14c450351b4af74ec0ae1bf0f2cf83f008e006803406977494a6b864ba276778eda40721315bc43c9490e31771773e5149ade739d7bb7aefa10a777d9baa81bf3f0b6ab02c5d464f76ab1532ed98f5fa8a68936556a22fb6ffa3f9b999dd950bbaac72364b874054ef23679bf94a2e8aaaada7575680ec6a2b07c0b0fff7f697adf09484e4007074052da7f9378f752b735a7b5e012aedab01d199f03716adab4afc1a49b8bfc56444a44e7be4040bd4957eb41672ab3a1d63897777ca53ec120045d0bf233c2eecdc104c0cdb3b62ecb92655b5d3396c83bb7ec02ca914a57a69dcd0c4f0da04df48763576da3ed3107b7c2a2488e4c843cb965d5fb1e090556b9e502438a111c82cc96b2d5e5bf5e28bd8e69a29860ad16abd8da3849b4b25a51a994511c93044890852985ef3f8d897818fbfa224d301ed625b7083d6425b678e8b50cf41ab52da2985ba690d849b60c771875f99be5b3a3b396515be84f5b2dfb9c6678f95e9a59eb7fb01e972d63ff9ad654324c6cc10c50a56118db85a5f9139a872febb61f06fcfee416ff849ff874f2d03fac730a7ea81e563a13f4b840d23cff37993dddda72ed0258be5d103cf61cac6e9e4ea72e5024065670218540da5820b642eca2fe1058f5d652fa5350f180032a23c0aad85a32634ca9be2330a0e0a3d652ee89a0eefadc74eaa410880d3e1660b85ec9ba44ff9fba7aca0c413d93f91d0f38d655ade2ea16f096ee72f2af549a4cfcf576af2c3ad534137d7b5863edac6fb8a70a405885b71aaed8bd29f91f47a34e44fa09a775adfdf86e7dbd71ed7fddaa2addf61b77a9238e7a0fdb97c627b8331e81a81b33ba6c72713aa20e4fbf2fab133158ab9e7a7fe10f73548094ce2c695c6faca3afb12b10e4a5ea46bdb1386f3b2c9429f729a3f487cca6415e2abce118a55cd47bab0ceaa62fda2a823d563a13dc27e5acd1a253afed3d733e9f00cfbdaf88ad4d45468e8269d7084185974c09a0edbb5ad2ada77495837f32184eda78b9a7c2e9c9f2dc03c272c5c8e5c8288f9d9e15cb44c6345761fa39472f85eecfde9ebc746238851e572f9089a7de434354bd42e647283d8b294e4f711f35f6b88e8d41274fcbb387e9893b47b65d14f69fc7a11b46042bf07db9d29b457d0fa5a94f52e33c5bc635bf7e58de19ab561c733332de17c6d4f728b270127a96c38e1bb56c7c4dd373378480a53e55dde786396707267644536b2db58937d41e45f15aa517c2c1bcdfe16e0998708a44a47331e395503a2c67061a097159b5b568335db65bfdcf23a6cf82a7037b29677362384cd37772b568b8366d0778f93d22e95b163ac6b58e03277ce52738fb830dd09bb91377aac984995ef90c8a647124e3f25a6121c19f23050ab2e7b1cf3140d196f25879e78deab64704d5a618ef4504051a0c4410430d2c2490420639084c803a38e8837e18804118826118815118837128a00113615251b3317f1d2b64a58b630df1615afacc1ad29edf7ed290dca479fd7b926493e4fa90b3f55ceb7d13c34a1a8378ae3007a93f2aaf2e7bb7ee9935a8d5d5b960915a61a110449c21bc13acb24c21f1095d78c31effffec9c42ea6c088b044f3a64b71e84f5052e8fe7f76c7212b75a8eb187c80a96e5613271156ad66505fee1f0b83ef3e5be272ca5fb1eb3945dad3733ab4102ec7d7421d6688c62fbe9a5c73d5dfd2b20b3b92c166d0d485a102cb0c985cd8950bc62f59cdd5f0afba7f7ee05de1812e7ef06698d8b2facbe4265c393b9c49c634e31c727faf98d1d3c5d77fdd99fc15c58566a76b2a4ef6e055747f5b67f7e6a3dc61ed8e9cf0125151399714515e2523a535195ea5b029b9088ec87ec1a770046dfd09c5de89d7c5f8d92354d591995398a58e2a2a352d7ba40b4a64d501ef27ac944ac465cdd398f8e7d56f31affd19d739df469cf090a86900717c1e0fe8c50f98ac072f2c567aa64778c4df6e4f7505affa2c1d865d3a70b9a99271fb8f388f9ca06751df4dcb67cf438049e1c2c6fcace246a735cbb109cb60d566b60541d26ca55d55fe878b6f0062bc96f0b117573eb3b2e76853617aeef65b94c27f097f18876277cb7966493343a5d77d75c2f16f4a6aade5364f5d20b3e3e57595acd9dcea26515be37581ca041ee4827f94b7f377cb18974dad8f8a41c3ce9dc6c3507618e5c392b54aad845575d02047be8a9c7c7e0317a0c0fe3b00eb341a386dbd8d6368fe0888ef0c978b29ecca338aaa3bc1017ea425e8ecb7539afc495ba7266eacfd353df7ac6aaabbb4dfc2475928f921ee4474586be7832f784146dda7f30ac3792189d0e87f541127fedd7f7eadc55196c24229668f307c642277938ecbf39b1f1cc8d11c361065d53f0c7a045be991f25bf4ebf2a2ba550aec33f3ef7eba62cded8f98d9f71976ddef1967dbef191637e6c8681736e1b0c4c5cae19475aee99465e9e994759de59465dbe59475b7ed846df7618d43ec632ce31e632cd39d632cf35f62c23f232f595f00161fe741714b4cdd36058b9114c88659fe12a5d08e60b150463951c825eed4c769718a849c7465da61f3eb560c17b9e8eb3b7e4e9c2f574525d0fe4a4fc940f34c75e842cbb1c7eb2b65158a0f43f24a3f2f7813abb1023590d9a563758febb80b67f1bd0c98ea29bacc3af6755c1f7df040cfc2930cc9e8c51b21ef3c6561e12ff55c0d4ba92cc3a82b9d5a338fd5fb950aa773d5669031efe0cf7c19961cfea7a8dde4e4139239f91cd48677533ab5be259e8a098603d1833f40c35ab7b9a357a3bcefb00209033f8c2a6742652ba53cfea1af3597b39d9017ad8bd98644634239c11cc6a93c8d48ff0fd7efc2f6737d112d8d897e909140493fec227bbec3b044ec3adcd8cfe6e7842408d727add2dd0e3803f57b4442cebadc30a3e85c3d46cd5ed06a9b697ac4b453b498fc7a992e64bd03c1a1c6681c37833768c1aa3281b83d634953b1142120d4bd3b2163db6edeb87370b020b3cd1846e6d31bb1c3f2578b4dcd2633f94b36b5631090deb43418d9eada5d9bdf9ae9cd50df0efad597d385bd4b49cb94e7de5d3d2afbbb5ebb64de8119f56fae12bd3a91b387d76558941facbf1d47dc899610018bf0e98b245b13ebed42b8648d8756aa0de059709d05c9fb1394062f5030d762fd477400dc20813b1d3888a56cdbec73c6d8364cb9e2c7f6f02a3928d56253108c38b5fe52164917f05fd84b28082444f194e906fc2b2e6f4292a4f86381e2389dc9cefaae6e46d49578e821787f95119f34309e47e72940bc18c86155d343f9534f9a28497cb41c4b6d6a546d81dd15f553fd1b0ba6aff167ff3e96fd904fd9a4bab67d71f3ce834f0c69df6cc95a661e9d58bf3e17936a8836f303a0b2a014be11b0b89b7029af95271c96869b2cbf3b24d749d037b77c986ec3c779f2702d573572aa7aaf4456662d5b44d41f769a0df92a23a062ddf62461a4b717d1af5d89a43eb961a6c2fae236d4ccd8a2dd27acc0ed40b0e98aecfbb08a4f80577c677bfef6576858456de54cdbf2104dc70339d316a8ed27a889ca72546f1eef0f478203093b7cca362430ce049e5abe7001db4734edd19cee60c3b617355cf57a603f9ea86bc0b1be1be3d4ab2af472fd77a5da81f5cec3b1da2df91562fc89d1ffe8c679c57edef8f48f2cf982e5bf3638da1df38d89bfe69805ead4edc935f4059143aae4542cf5ddf58e9766f4884b06e2ab8816a6ef9f9d5236b8bdedfa21403d9f1510cffcb361047d76e1a2913d0105252a3fe18c1e85d3cedb172fe2b5d242616e7aadd968f9c384ee7c7871b14b5a4c7722ca4db23c7c6fd6fb42b0b4a2f3143bee023945d8613e35af764fa1d65d2d8eaad6a948ed660b50c46e7e2861949e59488168e7fb54b0693e72b794ba0012647ee659642013abbba61003a1ce79475c3ca64458da5ad14cf448e732c044b6649be8c656a96c562c1fa282e8fdb336654ff8491d1495f534522caaa6ee6a368a1d76c0a20799f3919481f2c9ccaa88bae1836d6ad1b80e2a348fad846065014da2ac282fe3ca0f7aba09aade47ebf20c33180a341f3c692d2a62d19ee8da1b1add06fdba40807844a060692f65f9458b59631ea73eea2edc7d9e0e06c97650c6bf145bb043c2b6e596cb51eff9af6fdd2e9c94309b4dce4d86d2d0c65f0bdba4ce6150580a4025d823e17c760c2fd9ced74f9debc66b32c2f1ea85eade5a27bdcdda48d276c58c307de88402e86eda530e019d12beaced839a2513cc0b4b9f1b342639438beb6d9a6d4dc2c468c103a6da271dcd6997cb4a6acffc6dc2bbd4e1009cd5e239c9240911af1e746bde0bc5e13c735eda5ae22cb56713db41468c738623eb2ab833e46f0b4c652d4c841e271188b25380bd8281ba39d5f6ad09e2befd8e0f0e1660fab7dc76ce1615244cfce0d718e0056384430e6f6561c9025712a65b2b3328ad99e0832f1bc7c47c69abf2fe9ce904523377e460d959b53547908c88d9c0df912849e57f9cca345617aed6f7aa9de28fa3502095f97d744f07ca7e883a84e7f59d786583f7ed5bfa3745794ecd85d77cc6c4af1b4bc46e98a03e69113c1cc7a488f1e8c2d7aec81d21b6928b2736c3ee4266df60d916b85458251fe2108028f18876170a5ae3c0eb8644e6288d89663128ea0a76c56562b91a2b7cd032c3dcc8ea4c88d912ae2106dd3b4c80ce4d5df22664ef9a0e883f865652331b598a25c837f01d9149a1912065978745f0b48ba84355bd14b410424b2a71f3a73229c182fcb573b38053c8fe47215872974d6eb6482c274eac33719358bda7365d2e35ef704e5e27751b70af4f42452a9abcf3904fffdf0ab1ccd59950b6cdfdfc1248b68718550b5717311bd28ff5fe8d06a44e72b2bbce5800c6b9905d63dd070539666b64dba6d9771f8fea1aab0a6185ef6ed0dd0b87adb8ae60b8b130c84f24d12bf613468c0e8dc34e0fa04ac400bd0229924f08ba1913a5c70928d079829280b733d0b439434cef0ab6e0acafa8b98f9c85b47e9b6dc128963339e85ad5d9eeaed97c41ba9200fb30ed7ac2c9a59b1e2594b799e89b7f14972aff4f8ceba37224247d99f1d54cc99007c685f80e24a4472a51b8082228a0aad47155a32a8ee48f372ec23f705000e69b23d94d8ff682877519d98b973f42de3a59de28009f12164cb01d6242a8bf6b21b02079604beb00c8b03aada5e64df6f78b03f420db2ee8a6494e16da5dcb269ddf3f50dba97b51fa8f24d0544929248c58f414b8b3a2251f34c285b52d53ce4b4bdd508ed84b9bab6914a633880598219279a45c299269e55a29927994de259269d5d9259279b43d2d9269f53b2c9d7059dae3016abfb4ca9a5638a39379603042dd7540b46eea917ac3cd32c3879a75df0e39b6ec1c70f3d2e45950d2bb9d2d92eabecb2ca2eabfc1a74d3c40b54e64916982c932e7059275b10b24dbe20659f6241c931e5829673aa0523d7d40b56ee69169c3cd32ef8f14eb7e0e39b1e97a22a7a74537e3fa9fc015600bf166442d09af427ef0ae26df90b58144170d635a8ee44e6c9e5617cdbfbac3aba037b544e83544fe5992be284eab3d81015dec8db78c905ef9a55975ee9d75a9be27417a889ae68de4a75ed7870ac22b2d03551bd7fb66796efecfa9def886bb7273b32632dde7e42093271d16ce4cd2a69f20c4a4ca4b26aee529094298125baab0d591be0f3b5a3e1f2f2e536e6c0b9f33240918c58936cf2ccd92fb24be47391e039e73ed8348dd15cb94c3dd1781a72bacc39d7dc9d5d6bfec0628a46ba228d2e84408b72e66c07ac46fc8ce4dc2bfe185ec4759ec13fcf166fa8eff71ea115f8cd15dcf103bc31c02bb046a29a277ac39adef88e75bdf3031bfae02736f5c92f6ce98bdfd8d6377fb0a31ffe6257bffcc39efef88f7dfd13e0408010878244381222c6b130094e4448712a4a863331729c8b53e04282129792547025852aaea552c38d34f6089e8e459dce33b0a4337826967526cfc2893a8b67e3c1ad71e52141d67f3de73592effbb547981cafceb9ae3f7d2c39f31ff899eed7a3ba47b5c297f51d249eceff13f57c2aada917b927867ac16f4aa19ecfa521894e7006bcf85ffd527afc7b5d65f498b2ba259c39d8f2cd9774cf5cd210eb07f4500db5fc228819bd20e3ce16071ab096d0291042c987877ce862de5cf509ea96d77234a31077b9b9f54530fa91b0d0c2a752728574c74961e0f7bb52c51cfdcfd3d25f1888d3f9391369eb08aba9a1c1381a33c9032ecf8d8a719eec52875b27759dc7439bb028e99f75370e55a4861134acc90355870fd68a2f072d9d078eea6c272148ec8862308042ee9820a3148979e8dd8b61e41369c8c273331017de0c32fa35f2bb930c16394aa1ba6c27de782d729e9b40379b1ec449f392ec4ae0c382611a89e9a677b038f9b2998ecd748ce8c881ccb4d0cb4839f6ba0b8ec5a93f2efcfc04e838a035eec45d4aca5d41c4f52617db7bb76edf85d05599c9a08c3ff7f548722bb3786750d36d75bd3800c0adbdc6a0c70e805701787fde2f5b2a4291642909475e2f38058844e999ecd2d7a348add74beb1e5358a259c244c0dd9d9742a58dd3b2ae4547755a26e9cdd15304787a946bce984ae5821406a71b6e11007fb364b38b53ea1bb614217631225186c2b618ba15e58490d896e8a94606b151d83735e21957ad25d1fd2334ca444aa4bedf9d3634645a948dad08553018388f52227cda5e667f5ed1e7f5815134cdab28dd51175f0f851a7161d38dd65c9259368b31bd458d8969c3e809a34b4fc71283970740e7f1222985b3b998df3c2ecd25d9b069b4ee739684febc1d6867286afc1cbe8967f5d29eb014520892f2e058d23c9e17cd1eb8c074df6e09eb3a10ef93354a2242e02f81e9128469e6ff1319a14ba9cfa46afec7672bf05d2d42ef32b3a0524c5de818dc6b92888ac4c577f1514704121f3f948e870fd1b10e965cc4c564b75de862b679a73d79cd87816968701a6abc08baef3311967f585da0f23e2eee632ebcd51e1bcf23ad4b8ced82ae828d7e7f56a57a83f654818828e8bf22eb4b96bfbd5bdf8fbf7bb6e86e7f5bb668b7bfac2dfabbfd5db0b92a3d7fe0623a299cd99398e805ea14bd08cbc3b22dfb42cdd58f5f5c14174327950203b332d871b07ac7fb334b9c156eedab5fbdf8e2a797fd2c94d671e08937bcf9363b977e32427775377b218602e8bb52e9c8e486fbbde3ca48c7b4396dfc427bb6f75e095a778af53f74a31b79ac7a5a691cca9f902b3d09ab1d7f7e61e51ecbbdd3ea615fe055d70c067b791f21d052bebf38a6dec2177d31e866fc3204da34da0d5df6bc8e2f27d6490847a2371582485043ef18c7fe490850271845f2958b51486f0f0e7b06bdb501bab797ed9e26d305c5553815ae3e8b1713e0335bcec2bd058ee27ddd6bb3d6da6f76e59bf2748f5a3b0b70158fb2c738402ab287dc9b9304493eb2ceaf386cafbc23cd475b318de963e4aa7fd430fdb36b474fd92bd70273afc6806136329c5dbb252852b39844dcd9c2b9f5557b60c0c35c86dce0c0735efa82961bddbee0dd3d9090c241526e48d1aa3dc9133eea4f12fbbe0733f11ea7cdb7ab441630272db014e29d1b17b3f06a531fca48654a40cdef65e95c7892e158b8f12681f65e2fdc15db69053a3167faf06264764488191a99fb3d46baa58470843c7147e172cea84392a0a7c6f14b3562946f3c28738258276a3bd2909f00379bde4cb43408dad554e8a043ab84e00c92110e91fd6af6e81010fc9d0151a7555d5fedc9072989b24b97c304599bca487e5a235263c265239b36465864438aa8e7ffab0d8afaa6c5ba972b35e29324dd57fffad6af83eac1a1e24bcf2e8c554c2587a877118429be6af04f686d9c563c1ebb74d9cd791bc89e2dd19cd7317fe24395a8db45c16ca5d8bd843b24149fa4bcb31db75afaef7c82307105d2767671dd38193abc1b8272c7e3771345127b823660430df0a6fa3c89d946c6b58adf869aceeb53ecb81760a0e08558db57123f9464ca60e87c3fe0d3f266da66ee9dea422a2362a7269290fba8643e2a73efe601dbfcdc0e743bc39ab9798279d030270f722ae86f9244eb2532cb6f74b382845c5e076fc183070e2536ef00a8600b727b3991cf728703c3ad4586373fec2e37d02528bce5c231bc10c51400c34ae27c724509931940dc04a813a93502515a1f26691e656ce621575d382604ae20a10341bc23d008060099b6d769b273bbbf3b49279e07aad77d9bce3e31e70f0e2c5e2a7d3a7af15ab8d5b3d580d2d141d7c0aa02848261246fe5dd557f0b08c46090b4bf872a08488f68c6e75b3d31dbd8c97210e56083dbc24423668b61869c67a3458a45595c976463f678633c9562911462601b733c4eacbc630ab229c91a158db2d2e567e366f74f16427f176151b234f02aab2ad5d044ce7bf3c0c655695da45c21625255c7b6740be5d3eb317b0fa5de25de38a9255f176bb9bcd19793aa564d419e79de9b08662616d5cc1c21df3223d0d801fa330c8e3cfdce878c1edac6c1c19b0d2cb327ef7293fe0ba54717f360a9273ba224e5cb3bc07bf5b25a2896d15e624afd57296a446868d24a9f4c81d4ef3f4186afa4731ced3fc6db6053cf60ad93ac963090747e61ababaa0647e73f48aa59a29d8e5db2e36677e0570c45b24776c452b9fbfcdd9c0f03ee50f0009e4151c2bb2584276d72eae8039c0261e4db2895df242e188930d9d6b783c214b9dda69b87a7183954f3c1f0f29b7e765046feb4c547089d215108d101c2eb94a775caf3def42d77bcd57fff1c1b87861b6ebcf9cae1fda39389ee28e798edcfaec002afee081bd408bcb7324b9bd875f03319c2d3258ac6ea8088809eeeb8ef0b136b728a33772a166cc7a8388c922053fb62c2a70564693e88a3795181653ac6a2c16e929506b14ee9cfeb1ea0f10e55eea76ee405ecb0de51d085dda41c5868f9aa260f4bfee8e774383e6153bc5c7c7d0762e4c76ba3ed96c4fb0be0d0746358543a19e6e384d9acd269360ca6213d2911abcef303f1f8553b64cbb592f5b31afed8296482c0f52de8517de16828dd43a5745691242add053dc2a034cf9f33e6062aee4a58bdfe421f637295701b2df028c4f8483a58fcd084425bb19609347310f2a526f6dfcf0b9707d6d78569f395fb889e8198fa8aeceec4fb8b11fdbd9529b35f29d2e3226f222f2f3c6f1e2173ced987129f4dd40c91ba9ed21750a3ae099d2a036b58552d7bdab38c265fc670abdca7b1755b89482587d9f1b98a57921d585e21e4dc98d2d011be3c90c419595f379f14d56226a4eb1b396d5c589925360f3ec973148b21d7a330a210038c2a92bc0e232a56725d01d9bae0958e1146a0aa067c69e8b1cf257e6e0266df48d4f5688c07915043765509918b454f54469e74284ac5aacaa962a5946d82d3630158442219e36cea348c74ee22a162b98cba58a9d4a875cc4ca112dfd976b6cd2449abaea6bf9d21465b59e25c12090c734db64255bdcbeb509bc6f9134e5897bf8ff89a9a62dc3c2382fbb11d35ed7d1d46d9bf397aae7664274c5a40568cc10e067618d55b7533a3439ac4f8813e8b22efd7de77ebc7129f4f2450552727401ba141c585a663150922b11c125e4f24ec0be560430317c940306f891a8aa22cb875f044938a1e41ac9715b7851c57f2ca6b6d0ab496e04b871d6da9df1e171e4b078dc399dba446ebfe157de544fa2da907a3734198210ef24abecec37d6a060465e2f4ee4238e7ac093891a26910598cdf73b0f77b9fa69f20cb8f73a71896a6d48a89e480934084fc621427a963484cb41a1685f30a8d03dd8d74228443751292eb5b67050d326da0101abdb85f2f95541329c44720436cd8ec2f5f9b2e41c8aef90f07859afd2e344f65c8da659727281969210239df3aa1a67640caca891fe8338a0a207d5297d2b62d128c898f98b98f00eccef7bd1a60080ce5f5f79c4636ac9b0500efb037c04d0012008b08655c4845d52cdb713d7f0b8011c10e9840c277c7b9b27c2ddfd421831c1a9e09387b62f4f5250ae2c8f361bbe7accf05244097fcab50ec469473e2738e3306a3f71c58372c718fb9dc59003eec3d3593cfa0902b886067a885d8f37129804d36c990348eb91785359ec79c05ad277c70ebc7b48289a3e4ed6b7722dddc75577bf20263004e64d00fa7430e17832eb4715eaee031605a43336670d740eec703a79e7befee7afd9cf14cdd5a3f6b51de654faea034bfc21d7878be6a9c190c1bfcff3d9ecc4ee7e6310008c10816c5e1390449d10c97e5f1358228c98a56d5e93d8669d98ed7f5f9334118c54936cde57716cbd57ab3bbdddbef14655537ddb6d7bf391c4fe7cbedf5eefee7f17cbd3fbfdfbfffb70c0ec3acf5b768f83d210af943a1cccb9cb08675733e15f01d0eafcf0440cb131f9ebe95f039b22f14e97c0ac85c042a916e3d3eb1f276ac32652ffedef9ee563e4919752edc001282762c1997f54397e784c991efdd04bbf6bcbbdb21f92b335c4aef02f2a6753bfede13d3dc39f38bb71b340a5b80497f097f00ce383f0212cfc93e92000ad7464ea74e03f604b0fef2aa3c13d8d63e0f7af6e9f0024e6608a9ba7a59d04f29046060a77a2e31844b6df4a4104e418427354ea1364dd15c736a10f54238d967a81b435d1d10a67d9ae248de118de09d896101").unwrap();
    println!(
        "len = {}, first 4 {}, last 4 {}",
        compressed.len(),
        hex::encode(&compressed[0..4]),
        hex::encode(&compressed[compressed.len() - 4..])
    );
    let code = deploy::program_deployment_calldata(&compressed);
    let mut multicall_args = args_for_multicall(MulticallArg::Call, H160::zero(), None, code);
    let arbwasm_address = hex::decode(constants::ARB_WASM_ADDRESS).unwrap();
    let mut compile_calldata = vec![];
    let compile_method_hash = hex::decode(constants::ARBWASM_COMPILE_METHOD_HASH).unwrap();
    compile_calldata.extend(compile_method_hash);
    let mut extension = [0u8; 32];
    // Next, we add the address to the last 20 bytes of extension
    extension[12..32].copy_from_slice(expected_address.as_bytes());
    compile_calldata.extend(extension);
    multicall_append(
        &mut multicall_args,
        MulticallArg::Call,
        H160::from_slice(&arbwasm_address),
        compile_calldata,
    );
    println!("{}", hex::encode(&multicall_args));
    multicall_args
}

/// Converts arguments into the format the multicall Rust Stylus program expects.
fn args_for_multicall(
    opcode: MulticallArg,
    address: H160,
    value: Option<U256>,
    calldata: Vec<u8>,
) -> Vec<u8> {
    let mut args = vec![0x01];
    let mut length: u32 = 21 + calldata.len() as u32;
    if matches!(opcode, MulticallArg::Call) {
        length += 32;
    }
    args.extend(length.to_be_bytes());
    args.push(opcode.clone().into());

    if matches!(opcode, MulticallArg::Call) {
        let mut val = [0u8; 32];
        value.unwrap_or(U256::zero()).to_big_endian(&mut val);
        args.extend(val);
    }
    args.extend(address.as_bytes());
    args.extend(calldata);
    args
}

/// Adds another call to a multicall transaction.
fn multicall_append(calls: &mut Vec<u8>, opcode: MulticallArg, address: H160, inner: Vec<u8>) {
    calls[0] += 1; // add another call
    let args = args_for_multicall(opcode, address, None, inner);
    calls.extend(args[1..].iter().cloned());
}
